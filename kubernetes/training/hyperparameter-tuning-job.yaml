# Copyright 2024 [your name/company]
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

apiVersion: kubeflow.org/v1
kind: Experiment
metadata:
  name: hyperparameter-tuning-example
  namespace: training
spec:
  algorithm:
    algorithmName: random
    algorithmSettings:
    - name: random_state
      value: "42"
  parallelTrialCount: 3
  maxTrialCount: 20
  maxFailedTrialCount: 3
  objective:
    type: maximize
    objectiveMetricName: accuracy
    goal: 0.95
  parameters:
  - name: learning-rate
    parameterType: double
    feasibleSpace:
      min: "0.001"
      max: "0.1"
  - name: batch-size
    parameterType: int
    feasibleSpace:
      min: "16"
      max: "128"
  - name: optimizer
    parameterType: categorical
    feasibleSpace:
      list:
      - "adam"
      - "sgd"
      - "rmsprop"
  trialTemplate:
    goTemplate:
      rawTemplate: |
        apiVersion: batch/v1
        kind: Job
        metadata:
          name: {{.Trial}}
          namespace: {{.NameSpace}}
        spec:
          template:
            spec:
              priorityClassName: training
              nodeSelector:
                workload-type: training
                gpu-sharing: timeslice
              tolerations:
              - key: gpu
                operator: Equal
                value: "true"
                effect: NoSchedule
              containers:
              - name: training
                image: pytorch/pytorch:2.1.0-cuda11.8-cudnn8-runtime
                command:
                - python
                - train.py
                - --learning-rate={{.HyperParameters.learning-rate}}
                - --batch-size={{.HyperParameters.batch-size}}
                - --optimizer={{.HyperParameters.optimizer}}
                resources:
                  limits:
                    nvidia.com/gpu: 1
                    memory: 32Gi
                    cpu: 8
                  requests:
                    nvidia.com/gpu: 1
                    memory: 32Gi
                    cpu: 8
                volumeMounts:
                - name: datasets
                  mountPath: /datasets
                - name: checkpoints
                  mountPath: /checkpoints
              volumes:
              - name: datasets
                persistentVolumeClaim:
                  claimName: datasets-pvc
              - name: checkpoints
                persistentVolumeClaim:
                  claimName: checkpoints-pvc
          backoffLimit: 3

